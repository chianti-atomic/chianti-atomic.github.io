

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ChiantiPy.core.Continuum &mdash; ChiantiPy v0.7.1a</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/astropy_logo.ico"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="ChiantiPy v0.7.1a" href="../../../index.html"/>
        <link rel="up" title="ChiantiPy" href="../../ChiantiPy.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> ChiantiPy
          

          
          </a>

          
            
            
              <div class="version">
                0.7.1a
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting started with ChiantiPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../code_ref/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes.html">Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../IDL_intro.html">Intro for CHIANTI IDL Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../resources.html">Resources for ChiantiPy Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bugs.html">Reporting Bugs</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ChiantiPy</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../ChiantiPy.html">ChiantiPy</a> &raquo;</li>
        
      <li>ChiantiPy.core.Continuum</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ChiantiPy.core.Continuum</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Continuum module</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">splev</span><span class="p">,</span> <span class="n">splrep</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="k">import</span> <span class="n">map_coordinates</span>

<span class="kn">from</span> <span class="nn">.Ioneq</span> <span class="k">import</span> <span class="n">ioneq</span>
<span class="kn">from</span> <span class="nn">ChiantiPy.base</span> <span class="k">import</span> <span class="n">ionTrails</span>
<span class="kn">import</span> <span class="nn">ChiantiPy.tools.data</span> <span class="k">as</span> <span class="nn">chdata</span>
<span class="kn">import</span> <span class="nn">ChiantiPy.tools.util</span> <span class="k">as</span> <span class="nn">util</span>
<span class="kn">import</span> <span class="nn">ChiantiPy.tools.io</span> <span class="k">as</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">ChiantiPy.tools.constants</span> <span class="k">as</span> <span class="nn">const</span>
<span class="kn">import</span> <span class="nn">ChiantiPy.Gui</span> <span class="k">as</span> <span class="nn">chGui</span>


<div class="viewcode-block" id="continuum"><a class="viewcode-back" href="../../../api/ChiantiPy.core.continuum.html#ChiantiPy.core.Continuum.continuum">[docs]</a><span class="k">class</span> <span class="nc">continuum</span><span class="p">(</span><span class="n">ionTrails</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The top level class for continuum calculations. Includes methods for the calculation of the</span>
<span class="sd">    free-free and free-bound continua.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ionStr : `str`</span>
<span class="sd">        CHIANTI notation for the given ion, e.g. &#39;fe_12&#39; that corresponds to the Fe XII ion.</span>
<span class="sd">    temperature : array-like</span>
<span class="sd">        In units of Kelvin</span>
<span class="sd">    abundance : `float` or `str`, optional</span>
<span class="sd">        Elemental abundance relative to Hydrogen or name of CHIANTI abundance file,</span>
<span class="sd">        without the &#39;.abund&#39; suffix, e.g. &#39;sun_photospheric_1998_grevesse&#39;.</span>
<span class="sd">    em : array-like, optional</span>
<span class="sd">        Line-of-sight emission measure (:math:`\int\mathrm{d}l\,n_en_H`), in units of</span>
<span class="sd">        :math:`\mathrm{cm}^{-5}`, or the volumetric emission measure (:math:`\int\mathrm{d}V\,n_en_H`)</span>
<span class="sd">        in units of :math:`\mathrm{cm}^{-3}`.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import ChiantiPy.core as ch</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; temperature = np.logspace(4,9,20)</span>
<span class="sd">    &gt;&gt;&gt; cont = ch.continuum(&#39;fe_15&#39;,temperature)</span>
<span class="sd">    &gt;&gt;&gt; wavelength = np.arange(1,1000,10)</span>
<span class="sd">    &gt;&gt;&gt; cont.freeFree(wavelength)</span>
<span class="sd">    &gt;&gt;&gt; cont.freeBound(wavelength, include_abundance=True, include_ioneq=False)</span>
<span class="sd">    &gt;&gt;&gt; cont.calculate_free_free_loss()</span>
<span class="sd">    &gt;&gt;&gt; cont.calculate_free_bound_loss()</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The methods for calculating the free-free and free-bound emission and losses return</span>
<span class="sd">    their result to an attribute. See the respective docstrings for more information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ionStr</span><span class="p">,</span>  <span class="n">temperature</span><span class="p">,</span> <span class="n">abundance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">em</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">IonStr</span> <span class="o">=</span> <span class="n">ionStr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nameDict</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">convertName</span><span class="p">(</span><span class="n">ionStr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nameDict</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Stage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nameDict</span><span class="p">[</span><span class="s1">&#39;Ion&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nameDict</span><span class="p">[</span><span class="s1">&#39;Ion&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NTemperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="o">.</span><span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Defaults</span> <span class="o">=</span> <span class="n">chdata</span><span class="o">.</span><span class="n">Defaults</span>

        <span class="k">if</span> <span class="n">em</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Em</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">em</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Em</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">em</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">em</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Em</span> <span class="o">=</span> <span class="n">em</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">em</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Em</span> <span class="o">=</span> <span class="n">em</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Ip</span> <span class="o">=</span> <span class="n">chdata</span><span class="o">.</span><span class="n">Ip</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ipr</span> <span class="o">=</span> <span class="n">chdata</span><span class="o">.</span><span class="n">Ip</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stage</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ionization_potential</span> <span class="o">=</span> <span class="n">chdata</span><span class="o">.</span><span class="n">Ip</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">ev2Erg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">IprErg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ipr</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">ev2Erg</span>
        <span class="c1"># Set abundance</span>
        <span class="k">if</span> <span class="n">abundance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Abundance</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">abundance</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">abundance</span> <span class="ow">in</span> <span class="n">chdata</span><span class="o">.</span><span class="n">AbundanceList</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">AbundanceName</span> <span class="o">=</span> <span class="n">abundance</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">abundChoices</span> <span class="o">=</span> <span class="n">chdata</span><span class="o">.</span><span class="n">AbundanceList</span>
                    <span class="n">abundChoice</span> <span class="o">=</span> <span class="n">chGui</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">selectorDialog</span><span class="p">(</span><span class="n">abundChoices</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Select Abundance name&#39;</span><span class="p">)</span>
                    <span class="n">abundChoice_idx</span> <span class="o">=</span> <span class="n">abundChoice</span><span class="o">.</span><span class="n">selectedIndex</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">AbundanceName</span> <span class="o">=</span> <span class="n">abundChoices</span><span class="p">[</span><span class="n">abundChoice_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AbundanceName</span> <span class="o">=</span> <span class="n">chdata</span><span class="o">.</span><span class="n">Defaults</span><span class="p">[</span><span class="s1">&#39;abundfile&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Abundance&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Abundance</span> <span class="o">=</span> <span class="n">chdata</span><span class="o">.</span><span class="n">Abundance</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">AbundanceName</span><span class="p">][</span><span class="s1">&#39;abundance&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ioneqOne</span><span class="p">()</span>

<div class="viewcode-block" id="continuum.free_free_loss"><a class="viewcode-back" href="../../../api/ChiantiPy.core.html#ChiantiPy.core.Continuum.continuum.free_free_loss">[docs]</a>    <span class="k">def</span> <span class="nf">free_free_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the free-free energy loss rate of an ion. The result is returned to the</span>
<span class="sd">        `free_free_loss` attribute.</span>

<span class="sd">        The free-free radiative loss rate is given by Eq. 5.15a of [1]_. Writing the numerical</span>
<span class="sd">        constant in terms of the fine structure constant :math:`\\alpha`,</span>

<span class="sd">        .. math::</span>
<span class="sd">           \\frac{dW}{dtdV} = \\frac{4\\alpha^3h^2}{3\pi^2m_e}\left(\\frac{2\pi k_B}{3m_e}\\right)^{1/2}Z^2T^{1/2}\\bar{g}_B</span>

<span class="sd">        where where :math:`Z` is the nuclear charge, :math:`T` is the electron temperature, and</span>
<span class="sd">        :math:`\\bar{g}_{B}` is the wavelength-averaged and velocity-averaged Gaunt factor. The</span>
<span class="sd">        Gaunt factor is calculated using the methods of [2]_. Note that this expression for the</span>
<span class="sd">        loss rate is just the integral over wavelength of Eq. 5.14a of [1]_, the free-free emission, and</span>
<span class="sd">        is expressed in units of erg :math:`\mathrm{cm}^3\,\mathrm{s}^{-1}`.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        .. [1] Rybicki and Lightman, 1979, Radiative Processes in Astrophysics,</span>
<span class="sd">            `(Wiley-VCH) &lt;http://adsabs.harvard.edu/abs/1986rpa..book.....R&gt;`_</span>
<span class="sd">        .. [2] Karzas and Latter, 1961, ApJSS, `6, 167</span>
<span class="sd">            &lt;http://adsabs.harvard.edu/abs/1961ApJS....6..167K&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># interpolate wavelength-averaged K&amp;L gaunt factors</span>
        <span class="n">gf_kl_info</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">gffintRead</span><span class="p">()</span>
        <span class="n">gamma_squared</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ionization_potential</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atemp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> T:  </span><span class="si">%10.2e</span><span class="s1"> gamma_squared  </span><span class="si">%10.2e</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IonStr</span><span class="p">,</span> <span class="n">atemp</span><span class="p">,</span> <span class="n">gamma_squared</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">gaunt_factor</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">gamma_squared</span><span class="p">),</span>
                             <span class="n">splrep</span><span class="p">(</span><span class="n">gf_kl_info</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">],</span><span class="n">gf_kl_info</span><span class="p">[</span><span class="s1">&#39;gffint&#39;</span><span class="p">]),</span> <span class="n">ext</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="c1"># calculate numerical constant</span>
        <span class="n">prefactor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">fine</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mf">3.</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">emass</span>
                     <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">/</span><span class="mf">3.</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">emass</span><span class="p">))</span>
        <span class="c1"># include abundance and ionization equilibrium</span>
        <span class="n">prefactor</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Abundance</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ioneq_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Stage</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">free_free_loss</span> <span class="o">=</span> <span class="n">prefactor</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">)</span><span class="o">*</span><span class="n">gaunt_factor</span></div>

<div class="viewcode-block" id="continuum.freeFree"><a class="viewcode-back" href="../../../api/ChiantiPy.core.continuum.html#ChiantiPy.core.Continuum.continuum.freeFree">[docs]</a>    <span class="k">def</span> <span class="nf">freeFree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">include_abundance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_ioneq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the free-free emission for a single ion. The result is returned as a dict to</span>
<span class="sd">        the `FreeFree` attribute.  The dict has the keywords `intensity`, `wvl`, `temperature`, `em`.</span>

<span class="sd">        The free-free emission for the given ion is calculated according Eq. 5.14a of [1]_,</span>
<span class="sd">        substituting :math:`\\nu=c/\lambda`, dividing by the solid angle, and writing the numerical</span>
<span class="sd">        constant in terms of the fine structure constant :math:`\\alpha`,</span>

<span class="sd">        .. math::</span>
<span class="sd">           \\frac{dW}{dtdVd\lambda} = \\frac{c}{3m_e}\left(\\frac{\\alpha h}{\pi}\\right)^3\left(\\frac{2\pi}{3m_ek_B}\\right)^{1/2}\\frac{Z^2}{\lambda^2T^{1/2}}\exp{\left(-\\frac{hc}{\lambda k_BT}\\right)}\\bar{g}_{ff},</span>

<span class="sd">        where :math:`Z` is the nuclear charge, :math:`T` is the electron temperature in K, and</span>
<span class="sd">        :math:`\\bar{g}_{ff}` is the velocity-averaged Gaunt factor. The Gaunt factor is estimated</span>
<span class="sd">        using the methods of [2]_ and [3]_, depending on the temperature and energy regime. See</span>
<span class="sd">        `itoh_gaunt_factor` and `sutherland_gaunt_factor` for more details.</span>

<span class="sd">        The free-free emission is in units of erg</span>
<span class="sd">        :math:`\mathrm{cm}^3\mathrm{s}^{-1}\mathrm{\mathring{A}}^{-1}\mathrm{str}^{-1}`. If the emission</span>
<span class="sd">        measure has been set, the units will be multiplied by :math:`\mathrm{cm}^{-5}` or</span>
<span class="sd">        :math:`\mathrm{cm}^{-3}`, depending on whether it is the line-of-sight or volumetric</span>
<span class="sd">        emission measure, respectively.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wavelength : array-like</span>
<span class="sd">            In units of angstroms</span>
<span class="sd">        include_abundance : `bool`, optional</span>
<span class="sd">            If True, include the ion abundance in the final output.</span>
<span class="sd">        include_ioneq : `bool`, optional</span>
<span class="sd">            If True, include the ionization equilibrium in the final output</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        .. [1] Rybicki and Lightman, 1979, Radiative Processes in Astrophysics,</span>
<span class="sd">            `(Wiley-VCH) &lt;http://adsabs.harvard.edu/abs/1986rpa..book.....R&gt;`_</span>
<span class="sd">        .. [2] Itoh, N. et al., 2000, ApJS, `128, 125</span>
<span class="sd">            &lt;http://adsabs.harvard.edu/abs/2000ApJS..128..125I&gt;`_</span>
<span class="sd">        .. [3] Sutherland, R. S., 1998, MNRAS, `300, 321</span>
<span class="sd">            &lt;http://adsabs.harvard.edu/abs/1998MNRAS.300..321S&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span>
        <span class="c1"># define the numerical prefactor</span>
        <span class="n">prefactor</span> <span class="o">=</span> <span class="p">((</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="o">*</span><span class="mf">1e8</span><span class="p">)</span><span class="o">/</span><span class="mf">3.</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">emass</span>
                     <span class="o">*</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">fine</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
                     <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">3.</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">emass</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="p">))</span>
        <span class="c1"># include temperature dependence</span>
        <span class="n">prefactor</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_abundance</span><span class="p">:</span>
            <span class="n">prefactor</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Abundance</span>
        <span class="k">if</span> <span class="n">include_ioneq</span><span class="p">:</span>
            <span class="n">prefactor</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IoneqOne</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Em</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prefactor</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Em</span>
        <span class="c1"># define exponential factor</span>
        <span class="n">exp_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="p">(</span><span class="mf">1.e8</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="p">)</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span>
                            <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">wavelength</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># calculate gaunt factor</span>
        <span class="n">gf_itoh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itoh_gaunt_factor</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span>
        <span class="n">gf_sutherland</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sutherland_gaunt_factor</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span>
        <span class="n">gf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">gf_itoh</span><span class="p">),</span> <span class="n">gf_sutherland</span><span class="p">,</span> <span class="n">gf_itoh</span><span class="p">)</span>
        <span class="c1"># express in units of ergs or photons</span>
        <span class="n">energy_factor</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">chdata</span><span class="o">.</span><span class="n">Defaults</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;photon&#39;</span><span class="p">:</span>
            <span class="n">energy_factor</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="p">(</span><span class="mf">1.e8</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="p">)</span><span class="o">/</span><span class="n">wavelength</span>

        <span class="n">free_free_emission</span> <span class="o">=</span> <span class="p">(</span><span class="n">prefactor</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">exp_factor</span><span class="o">*</span><span class="n">gf</span><span class="o">/</span><span class="n">energy_factor</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FreeFree</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;intensity&#39;</span><span class="p">:</span><span class="n">free_free_emission</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">,</span> <span class="s1">&#39;wvl&#39;</span><span class="p">:</span><span class="n">wavelength</span><span class="p">,</span> <span class="s1">&#39;em&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Em</span><span class="p">,</span> <span class="s1">&#39;ions&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">IonStr</span><span class="p">}</span></div>

<div class="viewcode-block" id="continuum.freeFreeLoss"><a class="viewcode-back" href="../../../api/ChiantiPy.core.continuum.html#ChiantiPy.core.Continuum.continuum.freeFreeLoss">[docs]</a>    <span class="k">def</span> <span class="nf">freeFreeLoss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the free-free energy loss rate of an ion. The result is returned to the</span>
<span class="sd">        `FreeFreeLoss` attribute.</span>

<span class="sd">        The free-free radiative loss rate is given by Eq. 5.15a of [1]_. Writing the numerical</span>
<span class="sd">        constant in terms of the fine structure constant :math:`\\alpha`,</span>

<span class="sd">        .. math::</span>
<span class="sd">           \\frac{dW}{dtdV} = \\frac{4\\alpha^3h^2}{3\pi^2m_e}\left(\\frac{2\pi k_B}{3m_e}\\right)^{1/2}Z^2T^{1/2}\\bar{g}_B</span>

<span class="sd">        where where :math:`Z` is the nuclear charge, :math:`T` is the electron temperature, and</span>
<span class="sd">        :math:`\\bar{g}_{B}` is the wavelength-averaged and velocity-averaged Gaunt factor. The</span>
<span class="sd">        Gaunt factor is calculated using the methods of [2]_. Note that this expression for the</span>
<span class="sd">        loss rate is just the integral over wavelength of Eq. 5.14a of [1]_, the free-free emission, and</span>
<span class="sd">        is expressed in units of erg :math:`\mathrm{cm}^3\,\mathrm{s}^{-1}`.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        .. [1] Rybicki and Lightman, 1979, Radiative Processes in Astrophysics,</span>
<span class="sd">            `(Wiley-VCH) &lt;http://adsabs.harvard.edu/abs/1986rpa..book.....R&gt;`_</span>
<span class="sd">        .. [2] Karzas and Latter, 1961, ApJSS, `6, 167</span>
<span class="sd">            &lt;http://adsabs.harvard.edu/abs/1961ApJS....6..167K&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># interpolate wavelength-averaged K&amp;L gaunt factors</span>
        <span class="n">gf_kl_info</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">gffintRead</span><span class="p">()</span>
        <span class="n">gamma_squared</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IprErg</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span>
<span class="c1">#        for i, atemp in enumerate(self.Temperature):</span>
<span class="c1">#            print(&#39;%s T:  %10.2e gamma_squared  %10.2e&#39;%(self.IonStr, atemp, gamma_squared[i]))</span>
        <span class="n">gaunt_factor</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">gamma_squared</span><span class="p">),</span>
                             <span class="n">splrep</span><span class="p">(</span><span class="n">gf_kl_info</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">],</span><span class="n">gf_kl_info</span><span class="p">[</span><span class="s1">&#39;gffint&#39;</span><span class="p">]),</span> <span class="n">ext</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="c1"># calculate numerical constant</span>
        <span class="n">prefactor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">fine</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mf">3.</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">emass</span>
                     <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">/</span><span class="mf">3.</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">emass</span><span class="p">))</span>
        <span class="c1"># include abundance and ionization equilibrium</span>
        <span class="n">prefactor</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Abundance</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">IoneqOne</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">FreeFreeLoss</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rate&#39;</span><span class="p">:</span><span class="n">prefactor</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">)</span><span class="o">*</span><span class="n">gaunt_factor</span><span class="p">}</span></div>


<div class="viewcode-block" id="continuum.itoh_gaunt_factor"><a class="viewcode-back" href="../../../api/ChiantiPy.core.continuum.html#ChiantiPy.core.Continuum.continuum.itoh_gaunt_factor">[docs]</a>    <span class="k">def</span> <span class="nf">itoh_gaunt_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the free-free gaunt factors of [1]_.</span>

<span class="sd">        An analytic fitting formulae for the relativistic Gaunt factor is given by Eq. 4 of [1]_,</span>

<span class="sd">        .. math::</span>
<span class="sd">           g_{Z} = \sum^{10}_{i,j=0}a_{ij}t^iU^j</span>

<span class="sd">        where,</span>

<span class="sd">        .. math::</span>
<span class="sd">           t = \\frac{1}{1.25}(\log_{10}{T} - 7.25),\\</span>
<span class="sd">           U = \\frac{1}{2.5}(\log_{10}{u} + 1.5),</span>

<span class="sd">        :math:`u=hc/\lambda k_BT`, and :math:`a_{ij}` are the fitting coefficients and are read</span>
<span class="sd">        in using `ChiantiPy.tools.io.itohRead` and are given in Table 4 of [1]_. These values</span>
<span class="sd">        are valid for :math:`6&lt;\log_{10}(T)&lt; 8.5` and :math:`-4&lt;\log_{10}(u)&lt;1`.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        ChiantiPy.tools.io.itohRead : Read in Gaunt factor coefficients from [1]_</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        .. [1] Itoh, N. et al., 2000, ApJS, `128, 125</span>
<span class="sd">            &lt;http://adsabs.harvard.edu/abs/2000ApJS..128..125I&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># calculate scaled energy and temperature</span>
        <span class="n">lower_u</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="p">(</span><span class="mf">1.e8</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="p">)</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">)</span>
        <span class="n">upper_u</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">2.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lower_u</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.5</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">1.25</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">)</span> <span class="o">-</span> <span class="mf">7.25</span><span class="p">)</span>
        <span class="c1"># read in Itoh coefficients</span>
        <span class="n">itoh_coefficients</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">itohRead</span><span class="p">()[</span><span class="s1">&#39;itohCoef&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>
        <span class="c1"># calculate Gaunt factor</span>
        <span class="n">gf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">upper_u</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">):</span>
                <span class="n">gf</span> <span class="o">+=</span> <span class="p">(</span><span class="n">itoh_coefficients</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="n">i</span><span class="p">))[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">upper_u</span><span class="o">**</span><span class="n">j</span><span class="p">)</span>
        <span class="c1"># apply NaNs where Itoh approximation is not valid</span>
        <span class="n">gf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lower_u</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">4.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lower_u</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">),</span><span class="n">gf</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">gf</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">6.0</span><span class="p">,</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">8.5</span><span class="p">)),:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">return</span> <span class="n">gf</span></div>

<div class="viewcode-block" id="continuum.sutherland_gaunt_factor"><a class="viewcode-back" href="../../../api/ChiantiPy.core.continuum.html#ChiantiPy.core.Continuum.continuum.sutherland_gaunt_factor">[docs]</a>    <span class="k">def</span> <span class="nf">sutherland_gaunt_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the free-free gaunt factor calculations of [1]_.</span>

<span class="sd">        The Gaunt factors of [1]_ are read in using `ChiantiPy.tools.io.gffRead`</span>
<span class="sd">        as a function of :math:`u` and :math:`\gamma^2`. The data are interpolated</span>
<span class="sd">        to the appropriate wavelength and temperature values using</span>
<span class="sd">        `~scipy.ndimage.map_coordinates`.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        .. [1] Sutherland, R. S., 1998, MNRAS, `300, 321 &lt;http://adsabs.harvard.edu/abs/1998MNRAS.300..321S&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># calculate scaled quantities</span>
        <span class="n">lower_u</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="p">(</span><span class="mf">1.e8</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="p">)</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">,</span><span class="n">wavelength</span><span class="p">)</span>
        <span class="n">gamma_squared</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">ryd2erg</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">lower_u</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="c1"># convert to index coordinates</span>
        <span class="n">i_lower_u</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lower_u</span><span class="p">)</span> <span class="o">+</span> <span class="mf">4.</span><span class="p">)</span><span class="o">*</span><span class="mf">10.</span>
        <span class="n">i_gamma_squared</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">gamma_squared</span><span class="p">)</span> <span class="o">+</span> <span class="mf">4.</span><span class="p">)</span><span class="o">*</span><span class="mf">5.</span>
        <span class="c1"># read in sutherland data</span>
        <span class="n">gf_sutherland_data</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">gffRead</span><span class="p">()</span>
        <span class="c1"># interpolate data to scaled quantities</span>
        <span class="n">gf_sutherland</span> <span class="o">=</span> <span class="n">map_coordinates</span><span class="p">(</span><span class="n">gf_sutherland_data</span><span class="p">[</span><span class="s1">&#39;gff&#39;</span><span class="p">],</span>
                                        <span class="p">[</span><span class="n">i_gamma_squared</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">i_lower_u</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">lower_u</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gf_sutherland</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">gf_sutherland</span><span class="p">)</span></div>

<div class="viewcode-block" id="continuum.calculate_free_bound_loss"><a class="viewcode-back" href="../../../api/ChiantiPy.core.continuum.html#ChiantiPy.core.Continuum.continuum.calculate_free_bound_loss">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_free_bound_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the free-bound energy loss rate of an ion. The result is returned to the</span>
<span class="sd">        `free_bound_loss` attribute.</span>

<span class="sd">        The free-bound loss rate can be calculated by integrating the free-bound emission over the wavelength.</span>
<span class="sd">        This is difficult using the expression in `calculate_free_bound_emission` so we instead use the</span>
<span class="sd">        approach of [1]_ and [2]_. Eq. 1a of [2]_ can be integrated over wavelength to get the free-bound loss rate,</span>

<span class="sd">        .. math::</span>
<span class="sd">           \\frac{dW}{dtdV} = C_{ff}\\frac{k}{hc}T^{1/2}G_{fb},</span>

<span class="sd">        in units of erg :math:`\mathrm{cm}^3\,\mathrm{s}^{-1}` where :math:`G_{fb}` is the free-bound Gaunt factor as</span>
<span class="sd">        given by Eq. 15 of [2]_ (see `mewe_gaunt_factor` for more details) and :math:`C_{ff}` is the numerical constant</span>
<span class="sd">        as given in Eq. 4 of [1]_ and can be written in terms of the fine structure constant :math:`\\alpha`,</span>

<span class="sd">        .. math::</span>
<span class="sd">           C_{ff}\\frac{k}{hc} = \\frac{8}{3}\left(\\frac{\pi}{6}\\right)^{1/2}\\frac{h^2\\alpha^3}{\pi^2}\\frac{k_B}{m_e^{3/2}} \\approx 1.43\\times10^{-27}</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        .. [1] Gronenschild, E.H.B.M. and Mewe, R., 1978, A&amp;AS, `32, 283 &lt;http://adsabs.harvard.edu/abs/1978A%26AS...32..283G&gt;`_</span>
<span class="sd">        .. [2] Mewe, R. et al., 1986, A&amp;AS, `65, 511 &lt;http://adsabs.harvard.edu/abs/1986A%26AS...65..511M&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate Gaunt factor according to Mewe</span>
        <span class="n">gaunt_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mewe_gaunt_factor</span><span class="p">()</span>
        <span class="c1"># Numerical prefactor</span>
        <span class="n">prefactor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">8.</span><span class="o">/</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">6.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">fine</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                     <span class="o">*</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">emass</span><span class="o">**</span><span class="p">(</span><span class="mf">3.</span><span class="o">/</span><span class="mf">2.</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">free_bound_loss</span> <span class="o">=</span> <span class="n">gaunt_factor</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">)</span><span class="o">*</span><span class="n">prefactor</span></div>

<div class="viewcode-block" id="continuum.freeBoundLossMewe"><a class="viewcode-back" href="../../../api/ChiantiPy.core.html#ChiantiPy.core.Continuum.continuum.freeBoundLossMewe">[docs]</a>    <span class="k">def</span> <span class="nf">freeBoundLossMewe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the free-bound energy loss rate of an ion. The result is returned to the</span>
<span class="sd">        `free_bound_loss` attribute.</span>

<span class="sd">        The free-bound loss rate can be calculated by integrating the free-bound emission over the wavelength.</span>
<span class="sd">        This is difficult using the expression in `calculate_free_bound_emission` so we instead use the</span>
<span class="sd">        approach of [1]_ and [2]_. Eq. 1a of [2]_ can be integrated over wavelength to get the free-bound loss rate,</span>

<span class="sd">        .. math::</span>
<span class="sd">           \\frac{dW}{dtdV} = C_{ff}\\frac{k}{hc}T^{1/2}G_{fb},</span>

<span class="sd">        in units of erg :math:`\mathrm{cm}^3\,\mathrm{s}^{-1}` where :math:`G_{fb}` is the free-bound Gaunt factor as</span>
<span class="sd">        given by Eq. 15 of [2]_ (see `mewe_gaunt_factor` for more details) and :math:`C_{ff}` is the numerical constant</span>
<span class="sd">        as given in Eq. 4 of [1]_ and can be written in terms of the fine structure constant :math:`\\alpha`,</span>

<span class="sd">        .. math::</span>
<span class="sd">           C_{ff}\\frac{k}{hc} = \\frac{8}{3}\left(\\frac{\pi}{6}\\right)^{1/2}\\frac{h^2\\alpha^3}{\pi^2}\\frac{k_B}{m_e^{3/2}} \\approx 1.43\\times10^{-27}</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        .. [1] Gronenschild, E.H.B.M. and Mewe, R., 1978, A&amp;AS, `32, 283 &lt;http://adsabs.harvard.edu/abs/1978A%26AS...32..283G&gt;`_</span>
<span class="sd">        .. [2] Mewe, R. et al., 1986, A&amp;AS, `65, 511 &lt;http://adsabs.harvard.edu/abs/1986A%26AS...65..511M&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nameDict</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">convertName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IonStr</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">nameDict</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Recombined_fblvl</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">fblvlRead</span><span class="p">(</span><span class="n">lower</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;errorMessage&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Recombined_fblvl</span><span class="p">:</span>
            <span class="n">errorMessage</span> <span class="o">=</span> <span class="s1">&#39;No free-bound information available for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IonStr</span><span class="p">)</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FreeBoundLoss</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rate&#39;</span><span class="p">:</span><span class="n">rate</span><span class="p">,</span> <span class="s1">&#39;errorMessage&#39;</span><span class="p">:</span><span class="n">errorMessage</span><span class="p">}</span>
            <span class="k">return</span>
<span class="c1"># Calculate Gaunt factor according to Mewe</span>
        <span class="n">gaunt_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mewe_gaunt_factor</span><span class="p">()</span>
        <span class="c1"># Numerical prefactor</span>
        <span class="n">prefactor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">8.</span><span class="o">/</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">6.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">fine</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                     <span class="o">*</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">emass</span><span class="o">**</span><span class="p">(</span><span class="mf">3.</span><span class="o">/</span><span class="mf">2.</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">FreeBoundLoss</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rate&#39;</span><span class="p">:</span><span class="n">gaunt_factor</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">)</span><span class="o">*</span><span class="n">prefactor</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">}</span></div>

<div class="viewcode-block" id="continuum.mewe_gaunt_factor"><a class="viewcode-back" href="../../../api/ChiantiPy.core.continuum.html#ChiantiPy.core.Continuum.continuum.mewe_gaunt_factor">[docs]</a>    <span class="k">def</span> <span class="nf">mewe_gaunt_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the Gaunt factor according to [1]_ for a single ion :math:`Z_z`.</span>

<span class="sd">        Using Eq. 9 of [1]_, the free-bound Gaunt factor for a single ion can be written as,</span>

<span class="sd">        .. math::</span>
<span class="sd">           G_{fb}^{Z,z} = \\frac{E_H}{k_BT}\\mathrm{Ab}(Z)\\frac{N(Z,z)}{N(Z)}f(Z,z,n)</span>

<span class="sd">        where :math:`E_H` is the ground-state potential of H, :math:`\mathrm{Ab}(Z)` is the</span>
<span class="sd">        elemental abundance, :math:`\\frac{N(Z,z)}{N(Z)}` is the fractional ionization, and</span>
<span class="sd">        :math:`f(Z,z,n)` is given by Eq. 10 and is approximated by Eq 16 as,</span>

<span class="sd">        .. math::</span>
<span class="sd">           f(Z,z,n) \\approx f_2(Z,z,n_0) = 0.9\\frac{\zeta_0z_0^4}{n_0^5}\exp{\left(\\frac{E_Hz_0^2}{n_0^2k_BT}\\right)} + 0.42\\frac{z^4}{n_0^{3/2}}\exp{\left(\\frac{E_Hz^2}{(n_0 + 1)^2k_BT}\\right)}</span>

<span class="sd">        where :math:`n_0` is the principal quantum number, :math:`z_0` is the effective charge (see Eq. 7 of [1]_),</span>
<span class="sd">        and :math:`\zeta_0` is the number of vacancies in the 0th shell and is given in Table 1 of [1]_.</span>
<span class="sd">        Here it is calculated in the same manner as in `fb_rad_loss.pro &lt;http://www.chiantidatabase.org/idl/continuum/fb_rad_loss.pro&gt;`_</span>
<span class="sd">        of the CHIANTI IDL library. Note that in the expression for :math:`G_{fb}`, we have not included</span>
<span class="sd">        the :math:`N_H/n_e` factor.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If no .fblvl file is available for this ion</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        .. [1] Mewe, R. et al., 1986, A&amp;AS, `65, 511 &lt;http://adsabs.harvard.edu/abs/1986A%26AS...65..511M&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># read in free-bound level information for the recombined ion</span>
        <span class="c1"># thermal energy scaled by H ionization potential</span>
        <span class="n">scaled_energy</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">ryd2erg</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span>
        <span class="c1"># set variables used in Eq. 16 of Mewe et al.(1986)</span>
        <span class="n">n_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Recombined_fblvl</span><span class="p">[</span><span class="s1">&#39;pqn&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="c1">#        z_0 = np.sqrt(self.ionization_potential/const.ryd2erg)*n_0</span>
        <span class="n">z_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ipr</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">ryd2erg</span><span class="p">)</span><span class="o">*</span><span class="n">n_0</span>

        <span class="c1"># calculate zeta_0, the number of vacancies in the recombining ion</span>
        <span class="c1"># see zeta_0 function in chianti/idl/continuum/fb_rad_loss.pro and</span>
        <span class="c1"># Table 1 of Mewe et al. (1986)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stage</span> <span class="o">&gt;</span> <span class="mi">22</span><span class="p">:</span>
            <span class="n">zeta_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stage</span> <span class="o">+</span> <span class="mi">55</span>
        <span class="k">elif</span> <span class="mi">8</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stage</span> <span class="o">&lt;=</span> <span class="mi">22</span><span class="p">:</span>
            <span class="n">zeta_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stage</span> <span class="o">+</span> <span class="mi">27</span>
        <span class="k">elif</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stage</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">zeta_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stage</span> <span class="o">+</span> <span class="mi">9</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zeta_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stage</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ipr</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Recombined_fblvl</span><span class="p">[</span><span class="s1">&#39;ecm&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">light</span>
<span class="c1">#        ip = self.ionization_potential - recombined_fblvl[&#39;ecm&#39;][0]*const.planck*const.light</span>
        <span class="n">f_2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.9</span><span class="o">*</span><span class="n">zeta_0</span><span class="o">*</span><span class="p">(</span><span class="n">z_0</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n_0</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">scaled_energy</span><span class="o">*</span><span class="p">(</span><span class="n">z_0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n_0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">ip</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">)</span>
               <span class="o">+</span> <span class="mf">0.42</span><span class="o">/</span><span class="p">(</span><span class="n">n_0</span><span class="o">**</span><span class="mf">1.5</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Stage</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span>

<span class="c1">#        return scaled_energy*f_2*self.Abundance*self.ioneq_one(self.Stage+1, **kwargs)</span>
        <span class="k">return</span> <span class="n">scaled_energy</span><span class="o">*</span><span class="n">f_2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Abundance</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">IoneqOne</span></div>
            <span class="c1">#</span>

<div class="viewcode-block" id="continuum.freeBoundLoss"><a class="viewcode-back" href="../../../api/ChiantiPy.core.continuum.html#ChiantiPy.core.Continuum.continuum.freeBoundLoss">[docs]</a>    <span class="k">def</span> <span class="nf">freeBoundLoss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        to calculate the free-bound (radiative recombination) energy loss rate coefficient of an ion,</span>
<span class="sd">        the ion is taken to be the target ion,</span>
<span class="sd">        including the elemental abundance and the ionization equilibrium population</span>
<span class="sd">        uses the Gaunt factors of Karzas, W.J, Latter, R, 1961, ApJS, 6, 167</span>
<span class="sd">        provides rate = ergs cm^-2 s^-1</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span>
        <span class="c1">#</span>
        <span class="n">nameDict</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">convertName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IonStr</span><span class="p">)</span>
        <span class="n">lowerDict</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">convertName</span><span class="p">(</span><span class="n">nameDict</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Fblvl&#39;</span><span class="p">):</span>
            <span class="n">fblvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fblvl</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fblvlname</span> <span class="o">=</span> <span class="n">nameDict</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.fblvl&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fblvlname</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Fblvl</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">fblvlRead</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IonStr</span><span class="p">)</span>
                <span class="n">fblvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fblvl</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stage</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">fblvl</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mult&#39;</span><span class="p">:[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">FreeBoundLoss</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;errorMessage&#39;</span><span class="p">:</span><span class="s1">&#39; file does not exist </span><span class="si">%s</span><span class="s1"> .fblvl&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fblvlname</span><span class="p">)}</span>
                <span class="k">return</span>
        <span class="c1">#  need some data for the recombined ion</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rFblvl&#39;</span><span class="p">):</span>
            <span class="n">rFblvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rFblvl</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rfblvlname</span> <span class="o">=</span> <span class="n">lowerDict</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.fblvl&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">rfblvlname</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rFblvl</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">fblvlRead</span><span class="p">(</span><span class="n">nameDict</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">])</span>
                <span class="n">rFblvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rFblvl</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">FreeBoundLoss</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;errorMessage&#39;</span><span class="p">:</span><span class="s1">&#39; file does not exist </span><span class="si">%s</span><span class="s1"> .fblvl&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">rfblvlname</span><span class="p">)}</span>
                <span class="k">return</span>
        <span class="c1">#</span>
        <span class="n">gIoneq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IoneqOne</span>
        <span class="c1">#</span>
        <span class="n">abund</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Abundance</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="n">nlvls</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rFblvl</span><span class="p">[</span><span class="s1">&#39;lvl&#39;</span><span class="p">])</span>
        <span class="c1"># pqn = principle quantum no. n</span>
        <span class="n">pqn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rFblvl</span><span class="p">[</span><span class="s1">&#39;pqn&#39;</span><span class="p">],</span> <span class="s1">&#39;int64&#39;</span><span class="p">)</span>
        <span class="c1"># l is angular moment quantum no. L</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">rFblvl</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">]</span>
        <span class="c1"># energy level in inverse cm</span>
        <span class="n">ecm</span> <span class="o">=</span> <span class="n">rFblvl</span><span class="p">[</span><span class="s1">&#39;ecm&#39;</span><span class="p">]</span>
        <span class="c1"># statistical weigths/multiplicities</span>
        <span class="n">multr</span> <span class="o">=</span> <span class="n">rFblvl</span><span class="p">[</span><span class="s1">&#39;mult&#39;</span><span class="p">]</span>
        <span class="n">mult</span> <span class="o">=</span> <span class="n">fblvl</span><span class="p">[</span><span class="s1">&#39;mult&#39;</span><span class="p">]</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1"># for the ionization potential, must use that of the recombined ion</span>
        <span class="c1">#</span>
<span class="c1">#        iprcm = self.Ipr/const.invCm2Ev</span>
        <span class="c1">#</span>
        <span class="c1"># get karzas-latter Gaunt factors</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Klgfb&#39;</span><span class="p">):</span>
            <span class="n">klgfb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Klgfb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Klgfb</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">klgfbRead</span><span class="p">()</span>
            <span class="n">klgfb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Klgfb</span>
        <span class="c1">#</span>
        <span class="n">nTemp</span> <span class="o">=</span> <span class="n">temperature</span><span class="o">.</span><span class="n">size</span>
        <span class="c1"># statistical weigths/multiplicities</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#wecm=1.e+8/(ipcm-ecm)</span>
        <span class="c1">#</span>
        <span class="c1"># sometime the rFblvl file does not exist</span>
        <span class="k">if</span> <span class="s1">&#39;mult&#39;</span> <span class="ow">in</span> <span class="n">fblvl</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;mult&#39;</span> <span class="ow">in</span> <span class="n">rFblvl</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">fbrate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlvls</span><span class="p">,</span><span class="n">nTemp</span><span class="p">),</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="n">ratg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlvls</span><span class="p">),</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ilvl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlvls</span><span class="p">):</span>
                <span class="c1"># scaled energy is relative to the ionization potential of each individual level</span>
                <span class="c1"># will add the average energy of a free electron to this to get typical photon energy to</span>
                <span class="c1"># evaluate the gaunt factor</span>
                <span class="n">hnuEv</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">*</span><span class="n">temperature</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">ev2Erg</span>
                <span class="n">iprLvlEv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ipr</span> <span class="o">-</span> <span class="n">const</span><span class="o">.</span><span class="n">invCm2Ev</span><span class="o">*</span><span class="n">ecm</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span>
                <span class="n">scaledE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">hnuEv</span><span class="o">/</span><span class="n">iprLvlEv</span><span class="p">)</span>
                <span class="n">thisGf</span> <span class="o">=</span> <span class="n">klgfb</span><span class="p">[</span><span class="s1">&#39;klgfb&#39;</span><span class="p">][</span><span class="n">pqn</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]]</span>
                <span class="n">spl</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">klgfb</span><span class="p">[</span><span class="s1">&#39;pe&#39;</span><span class="p">],</span> <span class="n">thisGf</span><span class="p">)</span>
                <span class="n">gf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">splev</span><span class="p">(</span><span class="n">scaledE</span><span class="p">,</span> <span class="n">spl</span><span class="p">))</span>
                <span class="n">ratg</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">multr</span><span class="p">[</span><span class="n">ilvl</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">mult</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># ratio of statistical weights</span>
                <span class="n">iprLvlErg</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">ev2Erg</span><span class="o">*</span><span class="n">iprLvlEv</span>
                <span class="n">fbrate</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratg</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">iprLvlErg</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">pqn</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]))</span><span class="o">*</span><span class="n">gf</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
            <span class="n">fbRate</span> <span class="o">=</span> <span class="n">abund</span><span class="o">*</span><span class="n">gIoneq</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">freeBoundLoss</span><span class="o">*</span><span class="p">(</span><span class="n">fbrate</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fbRate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nTemp</span><span class="p">),</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FreeBoundLoss</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rate&#39;</span><span class="p">:</span><span class="n">fbRate</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">:</span><span class="n">temperature</span><span class="p">}</span></div>

<div class="viewcode-block" id="continuum.freeBoundwB"><a class="viewcode-back" href="../../../api/ChiantiPy.core.html#ChiantiPy.core.Continuum.continuum.freeBoundwB">[docs]</a>    <span class="k">def</span> <span class="nf">freeBoundwB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">includeAbundance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">includeIoneq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">useVerner</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the free-bound emission of an ion. The result is returned as a 2D array to the</span>
<span class="sd">        `free_bound_emission` attribute.</span>

<span class="sd">        The total free-bound continuum emissivity is given by,</span>

<span class="sd">        .. math::</span>
<span class="sd">           \\frac{dW}{dtdVd\lambda} = \\frac{1}{4\pi}\\frac{2}{hk_Bc^3m_e\sqrt{2\pi k_Bm_e}}\\frac{E^5}{T^{3/2}}\sum_i\\frac{\omega_i}{\omega_0}\sigma_i^{bf}\exp\left(-\\frac{E - I_i}{k_BT}\\right)</span>

<span class="sd">        where :math:`E=hc/\lambda` is the photon energy, :math:`\omega_i` and :math:`\omega_0`</span>
<span class="sd">        are the statistical weights of the :math:`i^{\mathrm{th}}` level of the recombined ion</span>
<span class="sd">        and the ground level of the recombing ion, respectively, :math:`\sigma_i^{bf}` is the</span>
<span class="sd">        photoionization cross-section, and :math:`I_i` is the ionization potential of level :math:`i`.</span>
<span class="sd">        This expression comes from Eq. 12 of [3]_. For more information about the free-bound continuum</span>
<span class="sd">        calculation, see `Peter Young&#39;s notes on free-bound continuum`_.</span>

<span class="sd">        The photoionization cross-sections are calculated using the methods of [2]_ for the</span>
<span class="sd">        transitions to the ground state and [1]_ for all other transitions. See</span>
<span class="sd">        `verner_cross_section` and `karzas_cross_section` for more details.</span>

<span class="sd">        .. _Peter Young&#39;s notes on free-bound continuum: http://www.pyoung.org/chianti/freebound.pdf</span>

<span class="sd">        The free-bound emission is in units of erg</span>
<span class="sd">        :math:`\mathrm{cm}^3\mathrm{s}^{-1}\mathrm{\mathring{A}}^{-1}\mathrm{str}^{-1}`. If the emission</span>
<span class="sd">        measure has been set, the units will be multiplied by :math:`\mathrm{cm}^{-5}` or</span>
<span class="sd">        :math:`\mathrm{cm}^{-3}`, depending on whether it is the line-of-sight or volumetric</span>
<span class="sd">        emission measure, respectively.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wavelength : array-like</span>
<span class="sd">            In units of angstroms</span>
<span class="sd">        include_abundance : `bool`, optional</span>
<span class="sd">            If True, include the ion abundance in the final output.</span>
<span class="sd">        include_ioneq : `bool`, optional</span>
<span class="sd">            If True, include the ionization equilibrium in the final output</span>
<span class="sd">        use_verner : `bool`, optional</span>
<span class="sd">            If True, cross-sections of ground-state transitions using [2]_, i.e. `verner_cross_section`</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If no .fblvl file is available for this ion</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        .. [1] Karzas and Latter, 1961, ApJSS, `6, 167</span>
<span class="sd">            &lt;http://adsabs.harvard.edu/abs/1961ApJS....6..167K&gt;`_</span>
<span class="sd">        .. [2] Verner &amp; Yakovlev, 1995, A&amp;AS, `109, 125</span>
<span class="sd">            &lt;http://adsabs.harvard.edu/abs/1995A%26AS..109..125V&gt;`_</span>
<span class="sd">        .. [3] Young et al., 2003, ApJSS, `144, 135</span>
<span class="sd">            &lt;http://adsabs.harvard.edu/abs/2003ApJS..144..135Y&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wavelength</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; wavelength must have at least two values, current length </span><span class="si">%3i</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">wavelength</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NWavelength</span> <span class="o">=</span> <span class="n">wavelength</span><span class="o">.</span><span class="n">size</span>
        <span class="c1"># calculate the photon energy in erg</span>
        <span class="n">photon_energy</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="p">(</span><span class="mf">1.e8</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="p">)</span><span class="o">/</span><span class="n">wavelength</span>
        <span class="n">prefactor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                     <span class="o">*</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">emass</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">3.</span><span class="o">/</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="c1"># read the free-bound level information for the recombined and recombining ion</span>
        <span class="n">recombining_fblvl</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">fblvlRead</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IonStr</span><span class="p">)</span>
        <span class="c1"># get the multiplicity of the ground state of the recombining ion</span>
        <span class="k">if</span> <span class="s1">&#39;errorMessage&#39;</span> <span class="ow">in</span> <span class="n">recombining_fblvl</span><span class="p">:</span>
            <span class="n">omega_0</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">omega_0</span> <span class="o">=</span> <span class="n">recombining_fblvl</span><span class="p">[</span><span class="s1">&#39;mult&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Recombined_fblvl</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">fblvlRead</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nameDict</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;errorMessage&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Recombined_fblvl</span><span class="p">:</span>
<span class="c1">#            raise ValueError(&#39;No free-bound information available for {}&#39;.format(util.zion2name(self.Z, self.Stage)))</span>
            <span class="n">errorMessage</span> <span class="o">=</span> <span class="s1">&#39;No free-bound information available for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">zion2name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stage</span><span class="p">))</span>
            <span class="n">fb_emiss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NTemperature</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NWavelength</span><span class="p">),</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>
<span class="c1">#            self.free_bound_emission = fb_emiss.squeeze()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FreeBound</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;intensity&#39;</span><span class="p">:</span><span class="n">fb_emiss</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">,</span><span class="s1">&#39;wvl&#39;</span><span class="p">:</span><span class="n">wavelength</span><span class="p">,</span><span class="s1">&#39;em&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Em</span><span class="p">,</span> <span class="s1">&#39;errorMessage&#39;</span><span class="p">:</span><span class="n">errorMessage</span><span class="p">}</span>
            <span class="k">return</span>

        <span class="n">energy_over_temp_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="o">**</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">photon_energy</span><span class="o">**</span><span class="mf">5.</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="c1">#        if self.NWavelength &gt; 1:</span>
<span class="c1">#            print(&#39; energy shape %5i %5i&#39;%(energy_over_temp_factor.shape[0],energy_over_temp_factor.shape[1]))</span>
<span class="c1">#        else:</span>
<span class="c1">#            print(&#39; energy size %5i&#39;%(energy_over_temp_factor.size))</span>
        <span class="c1"># sum over levels of the recombined ion</span>
        <span class="n">sum_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">omega_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Recombined_fblvl</span><span class="p">[</span><span class="s1">&#39;mult&#39;</span><span class="p">]):</span>
            <span class="c1"># ionization potential for level i</span>
<span class="c1">#            ip = self.ionization_potential - recombined_fblvl[&#39;ecm&#39;][i]*const.planck*const.light</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IprErg</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Recombined_fblvl</span><span class="p">[</span><span class="s1">&#39;ecm&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">light</span>
            <span class="c1"># skip level if photon energy is not sufficiently high</span>
            <span class="k">if</span> <span class="n">ip</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">photon_energy</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ionization_potential</span> <span class="o">-</span> <span class="n">ip</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="c1"># calculate cross-section</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">useVerner</span><span class="p">:</span>
                <span class="n">cross_section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vernerCross</span><span class="p">(</span><span class="n">photon_energy</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cross_section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">karzasCross</span><span class="p">(</span><span class="n">photon_energy</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">Recombined_fblvl</span><span class="p">[</span><span class="s1">&#39;pqn&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">Recombined_fblvl</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="n">scaled_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">),</span> <span class="n">photon_energy</span> <span class="o">-</span> <span class="n">ip</span><span class="p">)</span>
            <span class="c1"># the exponential term can go to infinity for low temperatures</span>
            <span class="c1"># but if the cross-section is zero this does not matter</span>
            <span class="n">scaled_energy</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cross_section</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">sum_factor</span> <span class="o">+=</span> <span class="n">omega_i</span><span class="o">/</span><span class="n">omega_0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">scaled_energy</span><span class="p">)</span><span class="o">*</span><span class="n">cross_section</span>

        <span class="c1"># combine factors</span>
        <span class="n">fb_emiss</span> <span class="o">=</span> <span class="n">prefactor</span><span class="o">*</span><span class="n">energy_over_temp_factor</span><span class="o">*</span><span class="n">sum_factor</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="c1">#        if self.NWavelength &gt; 1:</span>
<span class="c1">#            print(&#39; fb emiss.shape %5i %5i&#39;%(fb_emiss.shape[0], fb_emiss.shape[1]))</span>
<span class="c1">#        else:</span>
<span class="c1">#            print(&#39; fb emiss.size %5i&#39;%(fb_emiss.size))</span>
        <span class="c1"># include abundance, ionization equilibrium, photon conversion, emission measure</span>
        <span class="k">if</span> <span class="n">includeAbundance</span><span class="p">:</span>
            <span class="n">fb_emiss</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Abundance</span>
            <span class="n">includeAbundance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Abundance</span>
        <span class="k">if</span> <span class="n">includeIoneq</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NTemperature</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NWavelength</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<span class="c1">#                    fb_emiss *= self.ioneq_one(self.Stage, **kwargs)[:,np.newaxis]</span>
                    <span class="n">fb_emiss</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IoneqOne</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                    <span class="n">includeAbundance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IoneqOne</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fb_emiss</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IoneqOne</span>
                    <span class="n">includeAbundance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IoneqOne</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fb_emiss</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IoneqOne</span>
                <span class="n">includeAbundance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IoneqOne</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Em</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Em</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">fb_emiss</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Em</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fb_emiss</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Em</span>

        <span class="k">if</span> <span class="n">chdata</span><span class="o">.</span><span class="n">Defaults</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;photon&#39;</span><span class="p">:</span>
            <span class="n">fb_emiss</span> <span class="o">/=</span> <span class="n">photon_energy</span>
        <span class="c1"># the final units should be per angstrom</span>
        <span class="n">fb_emiss</span> <span class="o">/=</span> <span class="mf">1e8</span>

<span class="c1">#        self.free_bound_emission = fb_emiss.squeeze()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FreeBound</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;intensity&#39;</span><span class="p">:</span><span class="n">fb_emiss</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="s1">&#39;temperature&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">,</span><span class="s1">&#39;wvl&#39;</span><span class="p">:</span><span class="n">wavelength</span><span class="p">,</span><span class="s1">&#39;em&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Em</span><span class="p">,</span> <span class="s1">&#39;ions&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">IonStr</span><span class="p">,</span>  <span class="s1">&#39;abundance&#39;</span><span class="p">:</span><span class="n">includeAbundance</span><span class="p">,</span> <span class="s1">&#39;ioneq&#39;</span><span class="p">:</span><span class="n">includeIoneq</span><span class="p">}</span></div>

<div class="viewcode-block" id="continuum.freeBound"><a class="viewcode-back" href="../../../api/ChiantiPy.core.continuum.html#ChiantiPy.core.Continuum.continuum.freeBound">[docs]</a>    <span class="k">def</span> <span class="nf">freeBound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wvl</span><span class="p">,</span> <span class="n">verner</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        to calculate the free-bound (radiative recombination) continuum rate coefficient of an ion, where</span>
<span class="sd">        the ion is taken to be the target ion,</span>
<span class="sd">        including the elemental abundance and the ionization equilibrium population</span>
<span class="sd">        uses the Gaunt factors of Karzas, W.J, Latter, R, 1961, ApJS, 6, 167</span>
<span class="sd">        for recombination to the ground level, the photoionization cross sections of</span>
<span class="sd">        Verner and Yakovlev, 1995, A&amp;ASS, 109, 125</span>
<span class="sd">        are used to develop the free-bound cross section</span>
<span class="sd">        includes the elemental abundance and the ionization fraction</span>
<span class="sd">        provides emissivity = ergs cm^-2 s^-1 str^-1 Angstrom ^-1</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">wvl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">wvl</span><span class="p">,</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span>
        <span class="n">hnu</span> <span class="o">=</span> <span class="mf">1.e+8</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="o">/</span><span class="n">wvl</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;IoneqOne&#39;</span><span class="p">):</span>
            <span class="n">gIoneq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IoneqOne</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ioneqOne</span><span class="p">()</span>
            <span class="n">gIoneq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IoneqOne</span>
        <span class="c1">#</span>
        <span class="c1"># put in freefree to go through ipymspectrum</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">gIoneq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FreeBound</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;errorMessage&#39;</span><span class="p">:</span><span class="s1">&#39; no non-zero values of ioneq&#39;</span><span class="p">}</span>
            <span class="k">return</span>
        <span class="c1">#</span>
        <span class="n">em</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Em</span>
        <span class="c1">#</span>
        <span class="c1"># the target ion contains that data for fblvl</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;Fblvl&#39;</span><span class="p">):</span>
            <span class="n">fblvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fblvl</span>
            <span class="k">if</span> <span class="s1">&#39;errorMessage&#39;</span> <span class="ow">in</span> <span class="n">fblvl</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">FreeBound</span> <span class="o">=</span> <span class="n">fblvl</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stage</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1">#dealing with the fully ionized stage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Fblvl</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mult&#39;</span><span class="p">:[</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">]}</span>
            <span class="n">fblvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fblvl</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fblvlname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nameDict</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.fblvl&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fblvlname</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Fblvl</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">fblvlRead</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IonStr</span><span class="p">)</span>
                <span class="n">fblvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fblvl</span>
            <span class="c1"># in case there is no fblvl file</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">FreeBound</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;errorMessage&#39;</span><span class="p">:</span><span class="s1">&#39; no fblvl file for ion </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IonStr</span><span class="p">)}</span>
                <span class="k">return</span>
        <span class="c1">#</span>
        <span class="c1">#  need data for the recombined ion</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;rFblvl&#39;</span><span class="p">):</span>
            <span class="n">rfblvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rFblvl</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nameDict</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span>
            <span class="n">lowerDict</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">convertName</span><span class="p">(</span><span class="n">lower</span><span class="p">)</span>
            <span class="n">fblvlname</span> <span class="o">=</span> <span class="n">lowerDict</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">+</span><span class="s1">&#39;.fblvl&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fblvlname</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rFblvl</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">fblvlRead</span><span class="p">(</span><span class="n">lower</span><span class="p">)</span>
                <span class="n">rfblvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rFblvl</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">FreeBound</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;errorMessage&#39;</span><span class="p">:</span><span class="s1">&#39; no fblvl file for ion </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IonStr</span><span class="p">)}</span>
                <span class="k">return</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="n">abund</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Abundance</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="n">nlvls</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rfblvl</span><span class="p">[</span><span class="s1">&#39;lvl&#39;</span><span class="p">])</span>
        <span class="c1"># pqn = principle quantum no. n</span>
        <span class="n">pqn</span> <span class="o">=</span> <span class="n">rfblvl</span><span class="p">[</span><span class="s1">&#39;pqn&#39;</span><span class="p">]</span>
        <span class="c1"># l is angular moment quantum no. L</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">rfblvl</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">]</span>
        <span class="c1"># energy level in inverse cm</span>
        <span class="n">ecm</span> <span class="o">=</span> <span class="n">rfblvl</span><span class="p">[</span><span class="s1">&#39;ecm&#39;</span><span class="p">]</span>
        <span class="c1"># statistical weigths/multiplicities</span>
        <span class="n">multr</span> <span class="o">=</span> <span class="n">rfblvl</span><span class="p">[</span><span class="s1">&#39;mult&#39;</span><span class="p">]</span>
        <span class="n">mult</span> <span class="o">=</span> <span class="n">fblvl</span><span class="p">[</span><span class="s1">&#39;mult&#39;</span><span class="p">]</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1"># for the ionization potential, must use that of the recombined ion</span>
        <span class="c1">#</span>
        <span class="n">iprcm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ipr</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">invCm2Ev</span>
        <span class="c1">#</span>
        <span class="c1"># get karzas-latter Gaunt factors</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;Klgfb&#39;</span><span class="p">):</span>
            <span class="n">klgfb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Klgfb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Klgfb</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">klgfbRead</span><span class="p">()</span>
            <span class="n">klgfb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Klgfb</span>
        <span class="c1">#</span>
        <span class="n">nWvl</span> <span class="o">=</span> <span class="n">wvl</span><span class="o">.</span><span class="n">size</span>
        <span class="n">nTemp</span> <span class="o">=</span> <span class="n">temperature</span><span class="o">.</span><span class="n">size</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">verner</span><span class="p">:</span>
            <span class="n">lvl1</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lvl1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1">#</span>
        <span class="n">nWvl</span> <span class="o">=</span> <span class="n">wvl</span><span class="o">.</span><span class="n">size</span>
        <span class="n">nTemp</span> <span class="o">=</span> <span class="n">temperature</span><span class="o">.</span><span class="n">size</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">verner</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vernerCross</span><span class="p">(</span><span class="n">wvl</span><span class="p">)</span>
            <span class="n">vCross</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VernerCross</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nTemp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nWvl</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlvls</span><span class="p">,</span><span class="n">nTemp</span><span class="p">,</span><span class="n">nWvl</span><span class="p">),</span><span class="s1">&#39;Bool&#39;</span><span class="p">)</span>
            <span class="n">fbrate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlvls</span><span class="p">,</span><span class="n">nTemp</span><span class="p">,</span><span class="n">nWvl</span><span class="p">),</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="n">fbRate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nTemp</span><span class="p">,</span><span class="n">nWvl</span><span class="p">),</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="n">expf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlvls</span><span class="p">,</span><span class="n">nTemp</span><span class="p">,</span><span class="n">nWvl</span><span class="p">),</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="n">ratg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlvls</span><span class="p">),</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="n">ratg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">multr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">mult</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">iprLvlEv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ipr</span> <span class="o">-</span> <span class="n">const</span><span class="o">.</span><span class="n">invCm2Ev</span><span class="o">*</span><span class="n">ecm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">iprLvlErg</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">ev2Erg</span><span class="o">*</span><span class="n">iprLvlEv</span>
            <span class="n">iprLvlCm</span> <span class="o">=</span> <span class="p">(</span><span class="n">iprcm</span> <span class="o">-</span> <span class="n">ecm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">itemp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nTemp</span><span class="p">):</span>
                <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">itemp</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.e+8</span><span class="o">/</span><span class="n">wvl</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">iprcm</span> <span class="o">-</span> <span class="n">ecm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">expf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">itemp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">iprLvlErg</span> <span class="o">-</span> <span class="mf">1.e+8</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="o">/</span><span class="n">wvl</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">*</span><span class="n">temperature</span><span class="p">[</span><span class="n">itemp</span><span class="p">]))</span>
                <span class="n">fbrate</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">itemp</span><span class="p">]</span> <span class="o">=</span> <span class="n">em</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">*</span><span class="n">abund</span><span class="o">*</span><span class="n">gIoneq</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="o">/</span><span class="p">(</span><span class="mf">1.e-8</span><span class="o">*</span><span class="n">wvl</span><span class="p">))</span><span class="o">**</span><span class="mi">5</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">verner</span><span class="o">*</span><span class="n">ratg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">expf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">itemp</span><span class="p">]</span><span class="o">*</span><span class="n">vCross</span><span class="o">/</span><span class="n">temperature</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">**</span><span class="mf">1.5</span>
            <span class="k">for</span> <span class="n">ilvl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lvl1</span><span class="p">,</span><span class="n">nlvls</span><span class="p">):</span>
                <span class="n">iprLvlEv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ipr</span> <span class="o">-</span> <span class="n">const</span><span class="o">.</span><span class="n">invCm2Ev</span><span class="o">*</span><span class="n">ecm</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span>
                <span class="n">iprLvlErg</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">ev2Erg</span><span class="o">*</span><span class="n">iprLvlEv</span>
                <span class="n">scaledE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ev2Ang</span><span class="o">/</span><span class="p">(</span><span class="n">iprLvlEv</span><span class="o">*</span><span class="n">wvl</span><span class="p">))</span>
                <span class="n">thisGf</span> <span class="o">=</span> <span class="n">klgfb</span><span class="p">[</span><span class="s1">&#39;klgfb&#39;</span><span class="p">][</span><span class="n">pqn</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]]</span>
                <span class="n">spl</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">klgfb</span><span class="p">[</span><span class="s1">&#39;pe&#39;</span><span class="p">],</span> <span class="n">thisGf</span><span class="p">)</span>
                <span class="n">gf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">splev</span><span class="p">(</span><span class="n">scaledE</span><span class="p">,</span> <span class="n">spl</span><span class="p">))</span>
                <span class="n">ratg</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">multr</span><span class="p">[</span><span class="n">ilvl</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">mult</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># ratio of statistical weights</span>
            <span class="c1">#</span>
                <span class="k">for</span> <span class="n">itemp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nTemp</span><span class="p">):</span>
                    <span class="n">expf</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">iprLvlErg</span> <span class="o">-</span> <span class="mf">1.e+8</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="o">/</span><span class="n">wvl</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">*</span><span class="n">temperature</span><span class="p">[</span><span class="n">itemp</span><span class="p">]))</span>
                    <span class="n">expf</span><span class="p">[</span><span class="n">ilvl</span><span class="p">,</span><span class="n">itemp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">iprLvlErg</span> <span class="o">-</span> <span class="mf">1.e+8</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="o">/</span><span class="n">wvl</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">*</span><span class="n">temperature</span><span class="p">[</span><span class="n">itemp</span><span class="p">]))</span>
                    <span class="n">mask</span><span class="p">[</span><span class="n">ilvl</span><span class="p">,</span><span class="n">itemp</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.e+8</span><span class="o">/</span><span class="n">wvl</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">iprcm</span> <span class="o">-</span> <span class="n">ecm</span><span class="p">[</span><span class="n">ilvl</span><span class="p">])</span>
                    <span class="n">fbrate</span><span class="p">[</span><span class="n">ilvl</span><span class="p">,</span><span class="n">itemp</span><span class="p">]</span> <span class="o">=</span> <span class="n">em</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">*</span><span class="n">abund</span><span class="o">*</span><span class="n">gIoneq</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">freeBound</span><span class="o">*</span><span class="n">ratg</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">iprLvlErg</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">pqn</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]))</span><span class="o">*</span><span class="n">gf</span><span class="o">*</span><span class="n">expf</span><span class="p">[</span><span class="n">ilvl</span><span class="p">,</span><span class="n">itemp</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">**</span><span class="mf">1.5</span><span class="o">*</span><span class="p">(</span><span class="n">wvl</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">fbrma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fbrate</span><span class="p">)</span>
            <span class="n">fbrma</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span>  <span class="n">mask</span>
            <span class="n">fbrma</span><span class="o">.</span><span class="n">fill_value</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">fbIntensity</span> <span class="o">=</span> <span class="n">fbrma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">#            for itemp in range(nTemp):</span>
<span class="c1">#                fbRate += em[itemp]*abund*gIoneq[itemp]*fbrma[itemp]</span>
<span class="c1">#            fbRate = fbrma.sum(axis=0)</span>
<span class="c1">#            fbRate.fill_value = 0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FreeBound</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;intensity&#39;</span><span class="p">:</span><span class="n">fbIntensity</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">:</span><span class="n">temperature</span><span class="p">,</span><span class="s1">&#39;wvl&#39;</span><span class="p">:</span><span class="n">wvl</span><span class="p">,</span><span class="s1">&#39;em&#39;</span><span class="p">:</span><span class="n">em</span><span class="p">}</span>
            <span class="c1">#</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">nTemp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nWvl</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlvls</span><span class="p">,</span><span class="n">nWvl</span><span class="p">),</span><span class="s1">&#39;Bool&#39;</span><span class="p">)</span>
            <span class="n">fbrate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlvls</span><span class="p">,</span><span class="n">nWvl</span><span class="p">),</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="n">expf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlvls</span><span class="p">,</span><span class="n">nWvl</span><span class="p">),</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="n">ratg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlvls</span><span class="p">),</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="c1"># mask is true for bad values</span>
            <span class="n">ratg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">multr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">mult</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">iprLvlEv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ipr</span> <span class="o">-</span> <span class="n">const</span><span class="o">.</span><span class="n">invCm2Ev</span><span class="o">*</span><span class="n">ecm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">iprLvlErg</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">ev2Erg</span><span class="o">*</span><span class="n">iprLvlEv</span>
            <span class="n">iprLvlCm</span> <span class="o">=</span> <span class="p">(</span><span class="n">iprcm</span> <span class="o">-</span> <span class="n">ecm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1">#</span>
            <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.e+8</span><span class="o">/</span><span class="n">wvl</span> <span class="o">&lt;</span> <span class="n">iprcm</span>
            <span class="n">expf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">iprLvlErg</span> <span class="o">-</span> <span class="n">hnu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">*</span><span class="n">temperature</span><span class="p">))</span>
            <span class="c1"># both expressions for fbrate[0] match the IDL output</span>
            <span class="n">fbrate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="o">/</span><span class="p">(</span><span class="mf">1.e-8</span><span class="o">*</span><span class="n">wvl</span><span class="p">))</span><span class="o">**</span><span class="mi">5</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">verner</span><span class="o">*</span><span class="n">ratg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">expf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">vCross</span><span class="o">/</span><span class="n">temperature</span><span class="o">**</span><span class="mf">1.5</span>
            <span class="c1"># factor of 1.e-8 converts to Angstrom^-1, otherwise it would be cm^-1</span>
<span class="c1">#            fbrate[0] = 1.e-8*const.freeBounde*hnu**5*ratg[0]*expf[0]*vCross/temperature**1.5</span>
            <span class="c1">#</span>
            <span class="k">for</span> <span class="n">ilvl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lvl1</span><span class="p">,</span><span class="n">nlvls</span><span class="p">):</span>
                <span class="n">iprLvlEv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ipr</span> <span class="o">-</span> <span class="n">const</span><span class="o">.</span><span class="n">invCm2Ev</span><span class="o">*</span><span class="n">ecm</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span>
                <span class="n">iprLvlErg</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">ev2Erg</span><span class="o">*</span><span class="n">iprLvlEv</span>
                <span class="n">iprLvlCm</span> <span class="o">=</span> <span class="p">(</span><span class="n">iprcm</span> <span class="o">-</span> <span class="n">ecm</span><span class="p">[</span><span class="n">ilvl</span><span class="p">])</span>
                <span class="c1"># scaled energy is relative to the ionization potential of each individual level</span>
                <span class="n">scaledE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ev2Ang</span><span class="o">/</span><span class="p">(</span><span class="n">iprLvlEv</span><span class="o">*</span><span class="n">wvl</span><span class="p">))</span>
                <span class="n">thisGf</span> <span class="o">=</span> <span class="n">klgfb</span><span class="p">[</span><span class="s1">&#39;klgfb&#39;</span><span class="p">][</span><span class="n">pqn</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]]</span>
                <span class="n">spl</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">klgfb</span><span class="p">[</span><span class="s1">&#39;pe&#39;</span><span class="p">],</span> <span class="n">thisGf</span><span class="p">)</span>
                <span class="n">gf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">splev</span><span class="p">(</span><span class="n">scaledE</span><span class="p">,</span> <span class="n">spl</span><span class="p">))</span>
                <span class="n">mask</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.e+8</span><span class="o">/</span><span class="n">wvl</span> <span class="o">&lt;</span> <span class="n">iprLvlCm</span>
                <span class="n">ratg</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">multr</span><span class="p">[</span><span class="n">ilvl</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">mult</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># ratio of statistical weights</span>
                <span class="n">expf</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">iprLvlErg</span> <span class="o">-</span> <span class="n">hnu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">*</span><span class="n">temperature</span><span class="p">))</span>
                <span class="n">fbrate</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">freeBound</span><span class="o">*</span><span class="n">ratg</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">iprLvlErg</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">pqn</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]))</span><span class="o">*</span><span class="n">expf</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span><span class="o">*</span><span class="n">gf</span><span class="o">/</span><span class="p">(</span><span class="n">temperature</span><span class="o">**</span><span class="mf">1.5</span><span class="o">*</span><span class="p">(</span><span class="n">wvl</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">fbrma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fbrate</span><span class="p">)</span>
            <span class="n">fbrma</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span>  <span class="n">mask</span>
            <span class="n">fbrma</span><span class="o">.</span><span class="n">fill_value</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">fbRate</span> <span class="o">=</span> <span class="n">em</span><span class="o">*</span><span class="n">abund</span><span class="o">*</span><span class="n">gIoneq</span><span class="o">*</span><span class="n">fbrma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fbRate</span><span class="o">.</span><span class="n">fill_value</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FreeBound</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fbRate&#39;</span><span class="p">:</span><span class="n">fbRate</span><span class="p">,</span> <span class="s1">&#39;intensity&#39;</span><span class="p">:</span><span class="n">fbRate</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">:</span><span class="n">temperature</span><span class="p">,</span><span class="s1">&#39;wvl&#39;</span><span class="p">:</span><span class="n">wvl</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span><span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;expf&#39;</span><span class="p">:</span><span class="n">expf</span><span class="p">,</span><span class="s1">&#39;vCross&#39;</span><span class="p">:</span><span class="n">vCross</span><span class="p">}</span>
        <span class="c1">#elif (nTemp &gt; 1) and (nWvl == 1):</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FreeBound</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;intensity&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nTemp</span><span class="p">,</span><span class="s1">&#39;float64&#39;</span><span class="p">),</span><span class="s1">&#39;errorMessage&#39;</span><span class="p">:</span><span class="s1">&#39; this is the case of a single wavelength&#39;</span><span class="p">}</span></div>

<div class="viewcode-block" id="continuum.freeBoundEmiss"><a class="viewcode-back" href="../../../api/ChiantiPy.core.html#ChiantiPy.core.Continuum.continuum.freeBoundEmiss">[docs]</a>    <span class="k">def</span> <span class="nf">freeBoundEmiss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wvl</span><span class="p">,</span> <span class="n">verner</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the free-bound (radiative recombination) continuum emissivity of an ion.</span>
<span class="sd">        Provides emissivity in units of ergs :math:`\mathrm{cm}^{-2}` :math:`\mathrm{s}^{-1}` :math:`\mathrm{str}^{-1}` :math:`\mathrm{\AA}^{-1}` for an individual ion.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Uses the Gaunt factors of [1]_ for recombination to the ground level</span>
<span class="sd">        - Uses the photoionization cross sections of [2]_ to develop the free-bound cross section</span>
<span class="sd">        - Does not include the elemental abundance or ionization fraction</span>
<span class="sd">        - The specified ion is the target ion</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        .. [1] Karzas and Latter, 1961, ApJSS, `6, 167</span>
<span class="sd">            &lt;http://adsabs.harvard.edu/abs/1961ApJS....6..167K&gt;`_</span>
<span class="sd">        .. [2] Verner &amp; Yakovlev, 1995, A&amp;AS, `109, 125</span>
<span class="sd">            &lt;http://adsabs.harvard.edu/abs/1995A%26AS..109..125V&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wvl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">wvl</span><span class="p">,</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span>
        <span class="n">hnu</span> <span class="o">=</span> <span class="mf">1.e+8</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="o">/</span><span class="n">wvl</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="n">em</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Em</span>
        <span class="c1">#</span>
        <span class="c1"># the target ion contains that data for fblvl</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;Fblvl&#39;</span><span class="p">):</span>
            <span class="n">fblvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fblvl</span>
            <span class="k">if</span> <span class="s1">&#39;errorMessage&#39;</span> <span class="ow">in</span> <span class="n">fblvl</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">FreeBound</span> <span class="o">=</span> <span class="n">fblvl</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stage</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1">#dealing with the fully ionized stage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Fblvl</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mult&#39;</span><span class="p">:[</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">]}</span>
            <span class="n">fblvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fblvl</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fblvlname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nameDict</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.fblvl&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fblvlname</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Fblvl</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">fblvlRead</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IonStr</span><span class="p">)</span>
                <span class="n">fblvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fblvl</span>
            <span class="c1"># in case there is no fblvl file</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">FreeBound</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;errorMessage&#39;</span><span class="p">:</span><span class="s1">&#39; no fblvl file for ion </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IonStr</span><span class="p">)}</span>
                <span class="k">return</span>
        <span class="c1">#</span>
        <span class="c1">#  need data for the recombined ion</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;rFblvl&#39;</span><span class="p">):</span>
            <span class="n">rfblvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rFblvl</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nameDict</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span>
            <span class="n">lowerDict</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">convertName</span><span class="p">(</span><span class="n">lower</span><span class="p">)</span>
            <span class="n">fblvlname</span> <span class="o">=</span> <span class="n">lowerDict</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">+</span><span class="s1">&#39;.fblvl&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fblvlname</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rFblvl</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">fblvlRead</span><span class="p">(</span><span class="n">lower</span><span class="p">)</span>
                <span class="n">rfblvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rFblvl</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">FreeBound</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;errorMessage&#39;</span><span class="p">:</span><span class="s1">&#39; no fblvl file for ion </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IonStr</span><span class="p">)}</span>
                <span class="k">return</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="n">nlvls</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rfblvl</span><span class="p">[</span><span class="s1">&#39;lvl&#39;</span><span class="p">])</span>
        <span class="c1"># pqn = principle quantum no. n</span>
        <span class="n">pqn</span> <span class="o">=</span> <span class="n">rfblvl</span><span class="p">[</span><span class="s1">&#39;pqn&#39;</span><span class="p">]</span>
        <span class="c1"># l is angular moment quantum no. L</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">rfblvl</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">]</span>
        <span class="c1"># energy level in inverse cm</span>
        <span class="n">ecm</span> <span class="o">=</span> <span class="n">rfblvl</span><span class="p">[</span><span class="s1">&#39;ecm&#39;</span><span class="p">]</span>
        <span class="c1"># statistical weigths/multiplicities</span>
        <span class="n">multr</span> <span class="o">=</span> <span class="n">rfblvl</span><span class="p">[</span><span class="s1">&#39;mult&#39;</span><span class="p">]</span>
        <span class="n">mult</span> <span class="o">=</span> <span class="n">fblvl</span><span class="p">[</span><span class="s1">&#39;mult&#39;</span><span class="p">]</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1"># for the ionization potential, must use that of the recombined ion</span>
        <span class="c1">#</span>
        <span class="n">iprcm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ipr</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">invCm2Ev</span>
        <span class="c1">#</span>
        <span class="c1"># get karzas-latter Gaunt factors</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;Klgfb&#39;</span><span class="p">):</span>
            <span class="n">klgfb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Klgfb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Klgfb</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">klgfbRead</span><span class="p">()</span>
            <span class="n">klgfb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Klgfb</span>
        <span class="c1">#</span>
        <span class="n">nWvl</span> <span class="o">=</span> <span class="n">wvl</span><span class="o">.</span><span class="n">size</span>
        <span class="n">nTemp</span> <span class="o">=</span> <span class="n">temperature</span><span class="o">.</span><span class="n">size</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">verner</span><span class="p">:</span>
            <span class="n">lvl1</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lvl1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1">#</span>
        <span class="n">nWvl</span> <span class="o">=</span> <span class="n">wvl</span><span class="o">.</span><span class="n">size</span>
        <span class="n">nTemp</span> <span class="o">=</span> <span class="n">temperature</span><span class="o">.</span><span class="n">size</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">verner</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vernerCross</span><span class="p">(</span><span class="n">wvl</span><span class="p">)</span>
            <span class="n">vCross</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VernerCross</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nTemp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nWvl</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlvls</span><span class="p">,</span><span class="n">nTemp</span><span class="p">,</span><span class="n">nWvl</span><span class="p">),</span><span class="s1">&#39;Bool&#39;</span><span class="p">)</span>
            <span class="n">fbrate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlvls</span><span class="p">,</span><span class="n">nTemp</span><span class="p">,</span><span class="n">nWvl</span><span class="p">),</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="n">fbRate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nTemp</span><span class="p">,</span><span class="n">nWvl</span><span class="p">),</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="n">expf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlvls</span><span class="p">,</span><span class="n">nTemp</span><span class="p">,</span><span class="n">nWvl</span><span class="p">),</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="n">ratg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlvls</span><span class="p">),</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="n">ratg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">multr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">mult</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">iprLvlEv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ipr</span> <span class="o">-</span> <span class="n">const</span><span class="o">.</span><span class="n">invCm2Ev</span><span class="o">*</span><span class="n">ecm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">iprLvlErg</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">ev2Erg</span><span class="o">*</span><span class="n">iprLvlEv</span>
            <span class="n">iprLvlCm</span> <span class="o">=</span> <span class="p">(</span><span class="n">iprcm</span> <span class="o">-</span> <span class="n">ecm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">itemp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nTemp</span><span class="p">):</span>
                <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">itemp</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.e+8</span><span class="o">/</span><span class="n">wvl</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">iprcm</span> <span class="o">-</span> <span class="n">ecm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">expf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">itemp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">iprLvlErg</span> <span class="o">-</span> <span class="mf">1.e+8</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="o">/</span><span class="n">wvl</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">*</span><span class="n">temperature</span><span class="p">[</span><span class="n">itemp</span><span class="p">]))</span>
                <span class="n">fbrate</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">itemp</span><span class="p">]</span> <span class="o">=</span> <span class="n">em</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="o">/</span><span class="p">(</span><span class="mf">1.e-8</span><span class="o">*</span><span class="n">wvl</span><span class="p">))</span><span class="o">**</span><span class="mi">5</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">verner</span><span class="o">*</span><span class="n">ratg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">expf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">itemp</span><span class="p">]</span><span class="o">*</span><span class="n">vCross</span><span class="o">/</span><span class="n">temperature</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">**</span><span class="mf">1.5</span>
            <span class="k">for</span> <span class="n">ilvl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lvl1</span><span class="p">,</span><span class="n">nlvls</span><span class="p">):</span>
                <span class="n">iprLvlEv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ipr</span> <span class="o">-</span> <span class="n">const</span><span class="o">.</span><span class="n">invCm2Ev</span><span class="o">*</span><span class="n">ecm</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span>
                <span class="n">iprLvlErg</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">ev2Erg</span><span class="o">*</span><span class="n">iprLvlEv</span>
                <span class="n">scaledE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ev2Ang</span><span class="o">/</span><span class="p">(</span><span class="n">iprLvlEv</span><span class="o">*</span><span class="n">wvl</span><span class="p">))</span>
                <span class="n">thisGf</span> <span class="o">=</span> <span class="n">klgfb</span><span class="p">[</span><span class="s1">&#39;klgfb&#39;</span><span class="p">][</span><span class="n">pqn</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]]</span>
                <span class="n">spl</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">klgfb</span><span class="p">[</span><span class="s1">&#39;pe&#39;</span><span class="p">],</span> <span class="n">thisGf</span><span class="p">)</span>
                <span class="n">gf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">splev</span><span class="p">(</span><span class="n">scaledE</span><span class="p">,</span> <span class="n">spl</span><span class="p">))</span>
                <span class="n">ratg</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">multr</span><span class="p">[</span><span class="n">ilvl</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">mult</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># ratio of statistical weights</span>
            <span class="c1">#</span>
                <span class="k">for</span> <span class="n">itemp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nTemp</span><span class="p">):</span>
                    <span class="n">expf</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">iprLvlErg</span> <span class="o">-</span> <span class="mf">1.e+8</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="o">/</span><span class="n">wvl</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">*</span><span class="n">temperature</span><span class="p">[</span><span class="n">itemp</span><span class="p">]))</span>
                    <span class="n">expf</span><span class="p">[</span><span class="n">ilvl</span><span class="p">,</span><span class="n">itemp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">iprLvlErg</span> <span class="o">-</span> <span class="mf">1.e+8</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="o">/</span><span class="n">wvl</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">*</span><span class="n">temperature</span><span class="p">[</span><span class="n">itemp</span><span class="p">]))</span>
                    <span class="n">mask</span><span class="p">[</span><span class="n">ilvl</span><span class="p">,</span><span class="n">itemp</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.e+8</span><span class="o">/</span><span class="n">wvl</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">iprcm</span> <span class="o">-</span> <span class="n">ecm</span><span class="p">[</span><span class="n">ilvl</span><span class="p">])</span>
                    <span class="n">fbrate</span><span class="p">[</span><span class="n">ilvl</span><span class="p">,</span><span class="n">itemp</span><span class="p">]</span> <span class="o">=</span> <span class="n">em</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">freeBound</span><span class="o">*</span><span class="n">ratg</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">iprLvlErg</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">pqn</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]))</span><span class="o">*</span><span class="n">gf</span><span class="o">*</span><span class="n">expf</span><span class="p">[</span><span class="n">ilvl</span><span class="p">,</span><span class="n">itemp</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">**</span><span class="mf">1.5</span><span class="o">*</span><span class="p">(</span><span class="n">wvl</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">fbrma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fbrate</span><span class="p">)</span>
            <span class="n">fbrma</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span>  <span class="n">mask</span>
            <span class="n">fbrma</span><span class="o">.</span><span class="n">fill_value</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">fbIntensity</span> <span class="o">=</span> <span class="n">fbrma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">#            for itemp in range(nTemp):</span>
<span class="c1">#                fbRate += em[itemp]*abund*gIoneq[itemp]*fbrma[itemp]</span>
<span class="c1">#            fbRate = fbrma.sum(axis=0)</span>
<span class="c1">#            fbRate.fill_value = 0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FreeBoundEmiss</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;emiss&#39;</span><span class="p">:</span><span class="n">fbIntensity</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">:</span><span class="n">temperature</span><span class="p">,</span><span class="s1">&#39;wvl&#39;</span><span class="p">:</span><span class="n">wvl</span><span class="p">,</span><span class="s1">&#39;em&#39;</span><span class="p">:</span><span class="n">em</span><span class="p">}</span>
            <span class="c1">#</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">nTemp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nWvl</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlvls</span><span class="p">,</span><span class="n">nWvl</span><span class="p">),</span><span class="s1">&#39;Bool&#39;</span><span class="p">)</span>
            <span class="n">fbrate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlvls</span><span class="p">,</span><span class="n">nWvl</span><span class="p">),</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="n">expf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlvls</span><span class="p">,</span><span class="n">nWvl</span><span class="p">),</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="n">ratg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlvls</span><span class="p">),</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="c1"># mask is true for bad values</span>
            <span class="n">ratg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">multr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">mult</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">iprLvlEv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ipr</span> <span class="o">-</span> <span class="n">const</span><span class="o">.</span><span class="n">invCm2Ev</span><span class="o">*</span><span class="n">ecm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">iprLvlErg</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">ev2Erg</span><span class="o">*</span><span class="n">iprLvlEv</span>
            <span class="n">iprLvlCm</span> <span class="o">=</span> <span class="p">(</span><span class="n">iprcm</span> <span class="o">-</span> <span class="n">ecm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1">#</span>
            <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.e+8</span><span class="o">/</span><span class="n">wvl</span> <span class="o">&lt;</span> <span class="n">iprcm</span>
            <span class="n">expf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">iprLvlErg</span> <span class="o">-</span> <span class="n">hnu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">*</span><span class="n">temperature</span><span class="p">))</span>
            <span class="c1"># both expressions for fbrate[0] match the IDL output</span>
            <span class="n">fbrate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="o">/</span><span class="p">(</span><span class="mf">1.e-8</span><span class="o">*</span><span class="n">wvl</span><span class="p">))</span><span class="o">**</span><span class="mi">5</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">verner</span><span class="o">*</span><span class="n">ratg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">expf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">vCross</span><span class="o">/</span><span class="n">temperature</span><span class="o">**</span><span class="mf">1.5</span>
            <span class="c1"># factor of 1.e-8 converts to Angstrom^-1, otherwise it would be cm^-1</span>
<span class="c1">#            fbrate[0] = 1.e-8*const.freeBounde*hnu**5*ratg[0]*expf[0]*vCross/temperature**1.5</span>
            <span class="c1">#</span>
            <span class="k">for</span> <span class="n">ilvl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lvl1</span><span class="p">,</span><span class="n">nlvls</span><span class="p">):</span>
                <span class="n">iprLvlEv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ipr</span> <span class="o">-</span> <span class="n">const</span><span class="o">.</span><span class="n">invCm2Ev</span><span class="o">*</span><span class="n">ecm</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span>
                <span class="n">iprLvlErg</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">ev2Erg</span><span class="o">*</span><span class="n">iprLvlEv</span>
                <span class="n">iprLvlCm</span> <span class="o">=</span> <span class="p">(</span><span class="n">iprcm</span> <span class="o">-</span> <span class="n">ecm</span><span class="p">[</span><span class="n">ilvl</span><span class="p">])</span>
                <span class="c1"># scaled energy is relative to the ionization potential of each individual level</span>
                <span class="n">scaledE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ev2Ang</span><span class="o">/</span><span class="p">(</span><span class="n">iprLvlEv</span><span class="o">*</span><span class="n">wvl</span><span class="p">))</span>
                <span class="n">thisGf</span> <span class="o">=</span> <span class="n">klgfb</span><span class="p">[</span><span class="s1">&#39;klgfb&#39;</span><span class="p">][</span><span class="n">pqn</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]]</span>
                <span class="n">spl</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">klgfb</span><span class="p">[</span><span class="s1">&#39;pe&#39;</span><span class="p">],</span> <span class="n">thisGf</span><span class="p">)</span>
                <span class="n">gf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">splev</span><span class="p">(</span><span class="n">scaledE</span><span class="p">,</span> <span class="n">spl</span><span class="p">))</span>
                <span class="n">mask</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.e+8</span><span class="o">/</span><span class="n">wvl</span> <span class="o">&lt;</span> <span class="n">iprLvlCm</span>
                <span class="n">ratg</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">multr</span><span class="p">[</span><span class="n">ilvl</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">mult</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># ratio of statistical weights</span>
                <span class="n">expf</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">iprLvlErg</span> <span class="o">-</span> <span class="n">hnu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">*</span><span class="n">temperature</span><span class="p">))</span>
                <span class="n">fbrate</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">freeBound</span><span class="o">*</span><span class="n">ratg</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">iprLvlErg</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">pqn</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]))</span><span class="o">*</span><span class="n">expf</span><span class="p">[</span><span class="n">ilvl</span><span class="p">]</span><span class="o">*</span><span class="n">gf</span><span class="o">/</span><span class="p">(</span><span class="n">temperature</span><span class="o">**</span><span class="mf">1.5</span><span class="o">*</span><span class="p">(</span><span class="n">wvl</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">fbrma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fbrate</span><span class="p">)</span>
            <span class="n">fbrma</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span>  <span class="n">mask</span>
            <span class="n">fbrma</span><span class="o">.</span><span class="n">fill_value</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">fbRate</span> <span class="o">=</span> <span class="n">em</span><span class="o">*</span><span class="n">fbrma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fbRate</span><span class="o">.</span><span class="n">fill_value</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FreeBoundEmiss</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;emiss&#39;</span><span class="p">:</span><span class="n">fbRate</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">:</span><span class="n">temperature</span><span class="p">,</span><span class="s1">&#39;wvl&#39;</span><span class="p">:</span><span class="n">wvl</span><span class="p">,</span> <span class="s1">&#39;em&#39;</span><span class="p">:</span><span class="n">em</span><span class="p">}</span>
        <span class="c1">#elif (nTemp &gt; 1) and (nWvl == 1):</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FreeBoundEmiss</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;emiss&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nTemp</span><span class="p">,</span><span class="s1">&#39;float64&#39;</span><span class="p">),</span><span class="s1">&#39;errorMessage&#39;</span><span class="p">:</span><span class="s1">&#39; this is the case of a single wavelength&#39;</span><span class="p">}</span></div>


<div class="viewcode-block" id="continuum.vernerCross"><a class="viewcode-back" href="../../../api/ChiantiPy.core.html#ChiantiPy.core.Continuum.continuum.vernerCross">[docs]</a>    <span class="k">def</span> <span class="nf">vernerCross</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wvl</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the photoionization cross-section using data from [1]_ for</span>
<span class="sd">        transitions to the ground state.</span>

<span class="sd">        The photoionization cross-section can be expressed as :math:`\sigma_i^{fb}=F(E/E_0)` where</span>
<span class="sd">        :math:`F` is an analytic fitting formula given by Eq. 1 of [1]_,</span>

<span class="sd">        .. math::</span>
<span class="sd">           F(y) = ((y-1)^2 + y_w^2)y^{-Q}(1 + \sqrt{y/y_a})^{-P},</span>

<span class="sd">        where :math:`E` is the photon energy, :math:`n` is the principal quantum number,</span>
<span class="sd">        :math:`l` is the orbital quantum number, :math:`Q = 5.5 + l - 0.5P`, and</span>
<span class="sd">        :math:`\sigma_0,E_0,y_w,y_a,P` are fitting paramters. These can be read in using</span>
<span class="sd">        `ChiantiPy.tools.io.vernerRead`.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        .. [1] Verner &amp; Yakovlev, 1995, A&amp;AS, `109, 125</span>
<span class="sd">            &lt;http://adsabs.harvard.edu/abs/1995A%26AS..109..125V&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># read verner data</span>
        <span class="n">verner_info</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">vernerRead</span><span class="p">()</span>
        <span class="n">eth</span> <span class="o">=</span> <span class="n">verner_info</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Stage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>   <span class="c1">#*const.ev2Erg</span>
        <span class="n">yw</span> <span class="o">=</span> <span class="n">verner_info</span><span class="p">[</span><span class="s1">&#39;yw&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Stage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ya</span> <span class="o">=</span> <span class="n">verner_info</span><span class="p">[</span><span class="s1">&#39;ya&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Stage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">verner_info</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Stage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># convert from megabarn to cm^2</span>
        <span class="n">sigma0</span> <span class="o">=</span> <span class="n">verner_info</span><span class="p">[</span><span class="s1">&#39;sig0&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Stage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-18</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="n">verner_info</span><span class="p">[</span><span class="s1">&#39;e0&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Stage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1">#*const.ev2Erg</span>
        <span class="n">q</span> <span class="o">=</span> <span class="mf">5.5</span> <span class="o">+</span> <span class="n">verner_info</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Stage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">p</span>

        <span class="c1"># scaled photon energy</span>
        <span class="n">en</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">ev2Ang</span><span class="o">/</span><span class="n">wvl</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">en</span><span class="o">/</span><span class="n">e0</span>
        <span class="c1"># fitting function</span>
        <span class="n">F</span> <span class="o">=</span> <span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">yw</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">q</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">ya</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>
        <span class="n">cross_section</span> <span class="o">=</span> <span class="n">sigma0</span><span class="o">*</span><span class="n">F</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">VernerCross</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">en</span> <span class="o">&lt;</span> <span class="n">eth</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">cross_section</span><span class="p">)</span></div>

<div class="viewcode-block" id="continuum.karzasCross"><a class="viewcode-back" href="../../../api/ChiantiPy.core.html#ChiantiPy.core.Continuum.continuum.karzasCross">[docs]</a>    <span class="k">def</span> <span class="nf">karzasCross</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">photon_energy</span><span class="p">,</span> <span class="n">ionization_potential</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the photoionization cross-sections using the Gaunt factors of [1]_.</span>

<span class="sd">        The free-bound photoionization cross-section is given by,</span>

<span class="sd">        .. math::</span>
<span class="sd">           \sigma_i^{bf} = 1.077294\\times8065.54\\times10^{16}\left(\\frac{I_i}{hc}\\right)^2\left(\\frac{hc}{E}\\right)^3\\frac{g_{bf}}{n_i},</span>

<span class="sd">        where :math:`I_i` is the ionization potential of the :math:`i^{\mathrm{th}}` level,</span>
<span class="sd">        :math:`E` is the photon energy, :math:`g_{bf}` is the Gaunt factor calculated</span>
<span class="sd">        according to [1]_, and :math:`n_i` is the principal quantum number of the</span>
<span class="sd">        :math:`i^{\mathrm{th}}` level. :math:`\sigma_i^{bf}` is units of :math:`\mathrm{cm}^{2}`.</span>
<span class="sd">        This expression is given by Eq. 13 of [2]_. For more information on the photoionization</span>
<span class="sd">        cross-sections, see `Peter Young&#39;s notes on free-bound continuum`_.</span>

<span class="sd">        .. _Peter Young&#39;s notes on free-bound continuum: http://www.pyoung.org/chianti/freebound.pdf</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        photon_energy : array-like</span>
<span class="sd">        ionization_potential : `float`</span>
<span class="sd">        n : `int`</span>
<span class="sd">        l : `int`</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        .. [1] Karzas and Latter, 1961, ApJSS, `6, 167</span>
<span class="sd">            &lt;http://adsabs.harvard.edu/abs/1961ApJS....6..167K&gt;`_</span>
<span class="sd">        .. [2] Young et al., 2003, ApJSS, `144, 135</span>
<span class="sd">            &lt;http://adsabs.harvard.edu/abs/2003ApJS..144..135Y&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># numerical constant, in Mbarn</span>
        <span class="n">kl_constant</span> <span class="o">=</span> <span class="mf">1.077294e-1</span><span class="o">*</span><span class="mf">8065.54e3</span>
        <span class="c1"># read in KL gaunt factor data</span>
        <span class="n">karzas_info</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">klgfbRead</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">karzas_info</span><span class="p">[</span><span class="s1">&#39;klgfb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">scaled_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">photon_energy</span><span class="o">/</span><span class="n">ionization_potential</span><span class="p">)</span>
            <span class="n">f_gf</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">karzas_info</span><span class="p">[</span><span class="s1">&#39;pe&#39;</span><span class="p">],</span> <span class="n">karzas_info</span><span class="p">[</span><span class="s1">&#39;klgfb&#39;</span><span class="p">][</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">l</span><span class="p">,:])</span>
            <span class="n">gaunt_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">splev</span><span class="p">(</span><span class="n">scaled_energy</span><span class="p">,</span> <span class="n">f_gf</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gaunt_factor</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="c1"># scaled energy factor, converted to cm^-1</span>
        <span class="n">energy_factor</span> <span class="o">=</span> <span class="p">(((</span><span class="n">ionization_potential</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                         <span class="o">*</span> <span class="p">((</span><span class="n">photon_energy</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">planck</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">light</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)))</span>
        <span class="c1"># cross-section, convert to cm^2</span>
        <span class="n">cross_section</span> <span class="o">=</span> <span class="p">(</span><span class="n">kl_constant</span><span class="o">*</span><span class="n">energy_factor</span><span class="o">*</span><span class="n">gaunt_factor</span><span class="o">/</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-18</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">photon_energy</span> <span class="o">&gt;=</span> <span class="n">ionization_potential</span><span class="p">,</span> <span class="n">cross_section</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span></div>



<div class="viewcode-block" id="continuum.klgfbInterp"><a class="viewcode-back" href="../../../api/ChiantiPy.core.continuum.html#ChiantiPy.core.Continuum.continuum.klgfbInterp">[docs]</a>    <span class="k">def</span> <span class="nf">klgfbInterp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wvl</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;A Python version of the CHIANTI IDL procedure karzas_xs.</span>

<span class="sd">        Interpolates free-bound gaunt factor of Karzas and Latter, (1961, Astrophysical Journal</span>
<span class="sd">        Supplement Series, 6, 167) as a function of wavelength (wvl).&#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">klgfb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Klgfb</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Klgfb</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">klgfbRead</span><span class="p">()</span>
            <span class="n">klgfb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Klgfb</span>
        <span class="c1"># get log of photon energy relative to the ionization potential</span>
        <span class="n">sclE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ip</span><span class="o">/</span><span class="p">(</span><span class="n">wvl</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">ev2ang</span><span class="p">))</span>
        <span class="n">thisGf</span> <span class="o">=</span> <span class="n">klgfb</span><span class="p">[</span><span class="s1">&#39;klgfb&#39;</span><span class="p">][</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">klgfb</span><span class="p">[</span><span class="s1">&#39;pe&#39;</span><span class="p">],</span> <span class="n">thisGf</span><span class="p">)</span>
        <span class="n">gf</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">sclE</span><span class="p">,</span> <span class="n">spl</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gf</span></div>

<div class="viewcode-block" id="continuum.ioneqOne"><a class="viewcode-back" href="../../../api/ChiantiPy.core.continuum.html#ChiantiPy.core.Continuum.continuum.ioneqOne">[docs]</a>    <span class="k">def</span> <span class="nf">ioneqOne</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Provide the ionization equilibrium for the selected ion as a function of temperature.</span>
<span class="sd">        Similar to but not identical to ion.ioneqOne() - the ion class needs to be able to handle</span>
<span class="sd">        the &#39;dielectronic&#39; ions</span>
<span class="sd">        returned in self.IoneqOne</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Temperature&#39;</span><span class="p">):</span>
            <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;IoneqAll&#39;</span><span class="p">):</span>
            <span class="n">ioneqAll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IoneqAll</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">IoneqAll</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">ioneqRead</span><span class="p">(</span><span class="n">ioneqname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Defaults</span><span class="p">[</span><span class="s1">&#39;ioneqfile&#39;</span><span class="p">])</span>
            <span class="n">ioneqAll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IoneqAll</span>
        <span class="c1">#</span>
        <span class="n">ioneqTemperature</span> <span class="o">=</span> <span class="n">ioneqAll</span><span class="p">[</span><span class="s1">&#39;ioneqTemperature&#39;</span><span class="p">]</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span>
        <span class="n">stage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stage</span>
        <span class="n">ioneqOne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">thisIoneq</span> <span class="o">=</span> <span class="n">ioneqAll</span><span class="p">[</span><span class="s1">&#39;ioneqAll&#39;</span><span class="p">][</span><span class="n">Z</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">stage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">gioneq</span> <span class="o">=</span> <span class="n">thisIoneq</span> <span class="o">&gt;</span> <span class="mf">0.</span>
        <span class="n">goodt1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span> <span class="o">&gt;=</span> <span class="n">ioneqTemperature</span><span class="p">[</span><span class="n">gioneq</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">goodt2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span> <span class="o">&lt;=</span> <span class="n">ioneqTemperature</span><span class="p">[</span><span class="n">gioneq</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">goodt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">goodt1</span><span class="p">,</span><span class="n">goodt2</span><span class="p">)</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ioneqTemperature</span><span class="p">[</span><span class="n">gioneq</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">thisIoneq</span><span class="p">[</span><span class="n">gioneq</span><span class="p">]),</span><span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">goodt</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">gIoneq</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">[</span><span class="n">goodt</span><span class="p">]),</span><span class="n">y2</span><span class="p">)</span>   <span class="c1">#,der=0)</span>
                <span class="n">ioneqOne</span><span class="p">[</span><span class="n">goodt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">gIoneq</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gIoneq</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">),</span><span class="n">y2</span><span class="p">)</span>
                <span class="n">ioneqOne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">gIoneq</span><span class="p">)</span>
                <span class="n">ioneqOne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">ioneqOne</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">IoneqOne</span> <span class="o">=</span> <span class="n">ioneqOne</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">IoneqOne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">)</span></div>


<div class="viewcode-block" id="continuum.ioneq_one"><a class="viewcode-back" href="../../../api/ChiantiPy.core.continuum.html#ChiantiPy.core.Continuum.continuum.ioneq_one">[docs]</a>    <span class="k">def</span> <span class="nf">ioneq_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the equilibrium fractional ionization of the ion as a function of temperature.</span>

<span class="sd">        Uses the `ChiantiPy.core.ioneq` module and does a first-order spline interpolation to the data. An</span>
<span class="sd">        ionization equilibrium file can be passed as a keyword argument, `ioneqfile`. This can</span>
<span class="sd">        be passed through as a keyword argument to any of the functions that uses the</span>
<span class="sd">        ionization equilibrium.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stage : int</span>
<span class="sd">            Ionization stage, e.g. 25 for Fe XXV</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">ioneq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ioneqName</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ioneqfile&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">ionization_equilibrium</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span><span class="p">,</span>
                                       <span class="n">splrep</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">Temperature</span><span class="p">,</span> <span class="n">tmp</span><span class="o">.</span><span class="n">Ioneq</span><span class="p">[</span><span class="n">stage</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ionization_equilibrium</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">ionization_equilibrium</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Ken Dere.
      Last updated on 03 Oct 2018.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.7.1a',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>